name: Git tagging automation on merge to master

on:
  pull_request:   # when pull request is closed, trigger this workflow
    types: [closed]
    branches:
      - master
  push:
    branches:
      ['**']

jobs:
    create_tag:
      runs-on: ubuntu-latest
      # run only if the pull request is actually merged, e.g. don't run if PR closed, but not merged
      if: github.event.pull_request.merged == true || github.event_name == 'push'

      steps:
        # step 1: checkout the code
        - name: Checkout code
          uses: actions/checkout@v6

        # Step 2: Determine bump type (for push events, always 'patch'; for PRs, scan the description)
        #    step will store the magnitude of the bump (e.g. major, minor, patch) ni environment var bump_type
        - name: Determine bump type
          id: bump_type
          run: |
            # For push events, always bump 'patch'
            if [ "${{ github.event_name }}" == "push" ]; then
              echo "bump_type=patch" >> $GITHUB_ENV
            else
              # For PRs, scan the PR description for #major or #minor
              PR_DESCRIPTION="${{ github.event.pull_request.body }}"
            
              if [[ "$PR_DESCRIPTION" == *"#major"* ]]; then
                echo "bump_type=major" >> $GITHUB_ENV
              elif [[ "$PR_DESCRIPTION" == *"#minor"* ]]; then
                echo "bump_type=minor" >> $GITHUB_ENV
              else
                echo "bump_type=patch" >> $GITHUB_ENV
              fi
            fi

        # Step 3: Log the event type and bump type
        - name: Log event and bump type
          run: |
            echo "Event Type: ${{ github.event_name }}"
            echo "Bump Type: ${{ env.bump_type }}"

        # Step 4: Bump version using anotherNick/github-tag-action (but do NOT apply the tag yet)
        - name: Bump and preview new tag (without applying it)
          uses: anothrNick/github-tag-action@v1.71.0
          id: bump
          with:
            tag-prefix: 'v'  # Prefix for the tag (e.g., v1.0.0)
            bump: ${{ env.bump_type }}
            push: false  # Prevent the action from pushing the tag (just compute it)
          # continue-on-error: true  # Prevents workflow from failing (we're just previewing here)

        # Step 5: Log the computed new tag (without applying it)
        - name: Log the computed new version tag (without applying it)
          run: |
            # Normally, the new tag would be in the output from the action
            echo "Computed new version tag (without applying it): ${{ steps.bump.outputs.new_tag }}"
        

