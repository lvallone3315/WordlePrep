name: Git tagging automation on merge to master

on:
  pull_request:   # when pull request is closed, trigger this workflow
    types: [closed]
    branches:
      - master

jobs:
    create_tag:
      runs-on: ubuntu-latest
      permissions:
        contents: write  # This allows the action to create and push tags
      # run only if the pull request is actually merged, e.g. don't run if PR closed, but not merged
      if: github.event.pull_request.merged == true || github.event_name == 'push'

      steps:
        # step 1: checkout the code, full fetch (not shallow) to see all tags
        - name: Checkout code
          uses: actions/checkout@v6
          with:
            fetch-depth: 0

        # Step 2: Determine bump type (for push events, if activated above, always 'patch'; for PRs, scan the description)
        #    step will store the magnitude of the bump (e.g. major, minor, patch) in environment var bump_type
        - name: Determine bump type
          id: bump_type
          run: |
            # Use a fallback for PR_DESCRIPTION to avoid null errors
            PR_DESCRIPTION="${{ github.event.pull_request.body || '' }}"
            
            # For push events, always bump 'patch' (note: disabled by trigger, left here for debugging)
            if [ "${{ github.event_name }}" == "push" ]; then
              echo "bump_type=patch" >> $GITHUB_ENV
            else
              # For PRs, scan the PR description for #major or #minor
              PR_DESCRIPTION="${{ github.event.pull_request.body }}"
            
              if [[ "$PR_DESCRIPTION" == *"#major"* ]]; then
                echo "bump_type=major" >> $GITHUB_ENV
              elif [[ "$PR_DESCRIPTION" == *"#minor"* ]]; then
                echo "bump_type=minor" >> $GITHUB_ENV
              else
                echo "bump_type=patch" >> $GITHUB_ENV
              fi
            fi

        # Step 3: Log the event type and bump type
        - name: Log event and bump type
          run: |
            echo "Event Type: ${{ github.event_name }}"
            echo "Bump Type: ${{ env.bump_type }}"

        # Step 4: Bump version using anothrNick/github-tag-action
        - name: Bump and preview new tag (without applying it)
          uses: anothrNick/github-tag-action@1.75.0
          id: bump
          env:
            GITHUB_TOKEN: ${{ secrets.TAGGING_PAT }}
            WITH_V: true        # Tells it to look for and create 'v' tags
            DRY_RUN: false       # Set to true if want to preview without pushing the new tag
            DEFAULT_BUMP: ${{ env.bump_type }}

        # Step 5: Log the computed new tag
        - name: Log the computed new version tag
          run: |
            # The new tag should be in the output from the action
            echo "Computed new version tag: ${{ steps.bump.outputs.new_tag }}"
        

